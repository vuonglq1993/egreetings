<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Reports</title>

<!-- Bootstrap 5 + Icons -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- Custom CSS -->
<link href="../src/css/style.css" rel="stylesheet">
<link href="../src/css/sidebar.css" rel="stylesheet">
</head>
<body>

<!-- Sidebar và Topbar -->
<div id="sidebar-container"></div>
<div id="topbar-container"></div>
<script type="module">
    import { loadAdminLayout } from "../src/js/admin-layout.js";
    loadAdminLayout();
</script>

<!-- Main Content -->
<main class="content">
<div class="container mt-4">
    <h2>Reports</h2>
    <table class="table table-striped mt-3">
        <thead>
            <tr>
                <th>#</th>
                <th>ID</th>
                <th>Report Date</th>
                <th>Total Transactions</th>
                <th>Total Payments</th>
                <th>Active Subscriptions</th>
                <th>Created At</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="reportTableBody"></tbody>
    </table>
</div>
</main>

<!-- Reports JS -->
<script type="module">
import { apiGet, apiPut, apiDelete } from "../src/js/api.js";

window.apiGet = apiGet;
window.apiPut = apiPut;
window.apiDelete = apiDelete;

async function loadReports() {
    try {
        const data = await apiGet("api/report");
        const tbody = document.getElementById("reportTableBody");
        if (!tbody) return console.error("tbody not found");

        tbody.innerHTML = "";

        if (!data || data.length === 0) {
            tbody.innerHTML = `<tr><td colspan="8" class="text-center">Không có dữ liệu</td></tr>`;
            return;
        }

        data.forEach((r, i) => {
            tbody.innerHTML += `<tr>
                <td>${i + 1}</td>
                <td>${r.id}</td>
                <td>${r.reportDate ? new Date(r.reportDate).toLocaleDateString("vi-VN") : "N/A"}</td>
                <td>${r.totalTransactions ?? 0}</td>
                <td>${r.totalPayments ? parseFloat(r.totalPayments).toFixed(2) : '0.00'}</td>
                <td>${r.activeSubscriptions ?? 0}</td>
                <td>${r.createdAt ? new Date(r.createdAt).toLocaleString("vi-VN") : ""}</td>
                <td>
                    <button class="btn btn-sm btn-primary" onclick="openEditModal(${r.id})">
                        <i class="bi bi-pencil"></i> Edit
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="deleteReport(${r.id})">
                        <i class="bi bi-trash"></i> Delete
                    </button>
                </td>
            </tr>`;
        });
    } catch (err) {
        console.error("Error loading reports:", err);
        const tbody = document.getElementById("reportTableBody");
        if (tbody) {
            tbody.innerHTML = `<tr><td colspan="8" class="text-center text-danger">Lỗi khi tải dữ liệu: ${err.message}</td></tr>`;
        }
    }
}

document.addEventListener("DOMContentLoaded", () => {
    loadReports();
});

window.loadReports = loadReports;
</script>

<script>
async function openEditModal(id) {
    try {
        const report = await window.apiGet(`api/report/${id}`);
        const newReportDate = prompt("Nhập ngày báo cáo mới (YYYY-MM-DD):", 
            report.reportDate ? new Date(report.reportDate).toISOString().split('T')[0] : "");
        if (!newReportDate) return;

        const newTotalTransactions = prompt("Nhập tổng số giao dịch:", report.totalTransactions || 0);
        const newTotalPayments = prompt("Nhập tổng thanh toán:", report.totalPayments || 0);
        const newActiveSubscriptions = prompt("Nhập số subscription đang hoạt động:", report.activeSubscriptions || 0);

        const reportData = {
            id: parseInt(id),
            reportDate: newReportDate,
            totalTransactions: parseInt(newTotalTransactions) || 0,
            totalPayments: parseFloat(newTotalPayments) || 0,
            activeSubscriptions: parseInt(newActiveSubscriptions) || 0,
            createdAt: report.createdAt
        };

        await window.apiPut(`api/report/${id}`, reportData);
        alert("Cập nhật report thành công!");
        window.loadReports();
    } catch (err) {
        console.error("Error editing report:", err);
        alert("Lỗi: " + (err.message || "Không thể cập nhật report"));
    }
}

async function deleteReport(id) {
    if (!confirm("Bạn có chắc chắn muốn xóa report này không?")) return;

    try {
        await window.apiDelete(`api/report/${id}`);
        alert("Xóa report thành công!");
        window.loadReports();
    } catch (err) {
        console.error("Error deleting report:", err);
        alert("Lỗi: " + (err.message || "Không thể xóa report"));
    }
}
</script>

<!-- Security + Logout -->
<script src="../src/js/logout.js"></script>
<script src="../src/js/protect-page.js"></script>

</body>
</html>
