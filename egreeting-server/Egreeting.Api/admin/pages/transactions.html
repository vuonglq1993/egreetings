<!DOCTYPE html>

<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transactions Management</title>
<!-- Bootstrap 5 + Icons -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- Custom CSS -->
<link href="../src/css/style.css" rel="stylesheet">
<link href="../src/css/sidebar.css" rel="stylesheet">

<style>
    .table-responsive {
        overflow-x: auto;
    }
    .table th {
        white-space: nowrap;
        background-color: #f8f9fa;
    }
    .table td {
        vertical-align: middle;
    }
    .table td span[title] {
        cursor: help;
    }
</style>


</head>

<body>


<!-- Sidebar và Topbar sẽ được load tự động -->
<div id="sidebar-container"></div>
<div id="topbar-container"></div>

<!-- Main Content -->
<main class="content">
    <div class="container mt-4">
        <h2>Quản lý Transactions</h2>
        <div class="table-responsive">
            <table class="table table-striped mt-3">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>ID</th>
                        <th>User</th>
                        <th>Template</th>
                        <th>Recipient Email</th>
                        <th>Subject</th>
                        <th>Message</th>
                        <th>Price</th>
                        <th>Payment Method</th>
                        <th>Payment Status</th>
                        <th>Sent At</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="transactionTableBody"></tbody>
            </table>
        </div>
    </div>
</main>

<!-- Edit Transaction Modal -->
<div class="modal fade" id="transactionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Chỉnh sửa Transaction</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="transactionForm">
                    <input type="hidden" id="transactionId">
                    <div class="mb-3">
                        <label class="form-label">Recipient Email</label>
                        <input type="email" class="form-control" id="transactionRecipientEmail" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Subject</label>
                        <input type="text" class="form-control" id="transactionSubject">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Message</label>
                        <textarea class="form-control" id="transactionMessage" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Price</label>
                        <input type="number" step="0.01" class="form-control" id="transactionPrice" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Payment Method</label>
                        <input type="text" class="form-control" id="transactionPaymentMethod">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Payment Status</label>
                        <select class="form-select" id="transactionPaymentStatus" required>
                            <option value="Pending">Pending</option>
                            <option value="Completed">Completed</option>
                            <option value="Failed">Failed</option>
                            <option value="Refunded">Refunded</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" onclick="saveTransaction()">Lưu</button>
            </div>
        </div>
    </div>
</div>

<!-- Load layout (sidebar + topbar) -->
<script type="module">
    import { loadAdminLayout } from "../src/js/admin-layout.js";
    loadAdminLayout();
</script>

<!-- Transactions JS -->
<script type="module">
    import { apiGet, apiPut, apiDelete } from "../src/js/api.js";

    window.apiGet = apiGet;
    window.apiPut = apiPut;
    window.apiDelete = apiDelete;

    let allTransactions = [];

    async function loadTransactions() {
        try {
            const data = await apiGet("api/transaction/with-relations");
            allTransactions = data;
            const tbody = document.getElementById("transactionTableBody");
            tbody.innerHTML = "";

            if (!data || data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="12" class="text-center">Không có dữ liệu</td></tr>`;
                return;
            }

            data.forEach((t, i) => {
                const subject = t.subject || "";
                const message = t.message || "";
                const subjectDisplay = subject.length > 30 ? subject.substring(0, 30) + "..." : subject;
                const messageDisplay = message.length > 50 ? message.substring(0, 50) + "..." : message;
                
                tbody.innerHTML += `<tr>
                    <td>${i + 1}</td>
                    <td>${t.id}</td>
                    <td>${t.userName || "N/A"}</td>
                    <td>${t.templateTitle || "N/A"}</td>
                    <td>${t.recipientEmail || ""}</td>
                    <td>
                        ${subject ? `<span title="${subject.replace(/"/g, '&quot;')}">${subjectDisplay}</span>` : '<span class="text-muted">N/A</span>'}
                    </td>
                    <td>
                        ${message ? `<span title="${message.replace(/"/g, '&quot;')}">${messageDisplay}</span>` : '<span class="text-muted">N/A</span>'}
                    </td>
                    <td><strong>${t.price ? t.price.toFixed(2) : "0.00"}</strong></td>
                    <td>${t.paymentMethod || '<span class="text-muted">N/A</span>'}</td>
                    <td><span class="badge bg-${getPaymentStatusColor(t.paymentStatus)}">${t.paymentStatus || "Pending"}</span></td>
                    <td>${t.sentAt ? new Date(t.sentAt).toLocaleString("vi-VN") : ""}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="openEditModal(${t.id})" title="Chỉnh sửa">
                            <i class="bi bi-pencil"></i> Edit
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteTransaction(${t.id})" title="Xóa">
                            <i class="bi bi-trash"></i> Delete
                        </button>
                    </td>
                </tr>`;
            });
        } catch (err) {
            console.error("Error loading transactions:", err);
            document.getElementById("transactionTableBody").innerHTML = 
                `<tr><td colspan="12" class="text-center text-danger">Lỗi khi tải dữ liệu: ${err.message}</td></tr>`;
        }
    }

    function getPaymentStatusColor(status) {
        switch(status) {
            case "Completed": return "success";
            case "Pending": return "warning";
            case "Failed": return "danger";
            case "Refunded": return "info";
            default: return "secondary";
        }
    }

    window.loadTransactions = loadTransactions;
    loadTransactions();
</script>

<script>
    let transactionModal;
    let currentTransaction = null;

    document.addEventListener("DOMContentLoaded", () => {
        transactionModal = new bootstrap.Modal(document.getElementById("transactionModal"));
    });

    async function openEditModal(id) {
        try {
            const transaction = await window.apiGet(`api/transaction/${id}`);
            currentTransaction = transaction;
            
            document.getElementById("transactionId").value = transaction.id;
            document.getElementById("transactionRecipientEmail").value = transaction.recipientEmail || "";
            document.getElementById("transactionSubject").value = transaction.subject || "";
            document.getElementById("transactionMessage").value = transaction.message || "";
            document.getElementById("transactionPrice").value = transaction.price || 0;
            document.getElementById("transactionPaymentMethod").value = transaction.paymentMethod || "";
            document.getElementById("transactionPaymentStatus").value = transaction.paymentStatus || "Pending";
            
            transactionModal.show();
        } catch (err) {
            console.error("Error loading transaction:", err);
            alert("Lỗi khi tải thông tin transaction: " + err.message);
        }
    }

    async function saveTransaction() {
        const id = document.getElementById("transactionId").value;
        const recipientEmail = document.getElementById("transactionRecipientEmail").value;
        const subject = document.getElementById("transactionSubject").value;
        const message = document.getElementById("transactionMessage").value;
        const price = parseFloat(document.getElementById("transactionPrice").value);
        const paymentMethod = document.getElementById("transactionPaymentMethod").value;
        const paymentStatus = document.getElementById("transactionPaymentStatus").value;

        if (!recipientEmail || price < 0) {
            alert("Vui lòng điền đầy đủ thông tin!");
            return;
        }

        try {
            const transactionData = {
                id: parseInt(id),
                userId: currentTransaction.userId,
                templateId: currentTransaction.templateId,
                recipientEmail: recipientEmail,
                subject: subject || null,
                message: message || null,
                price: price,
                paymentMethod: paymentMethod || null,
                paymentStatus: paymentStatus,
                sentAt: currentTransaction.sentAt
            };

            await window.apiPut(`api/transaction/${id}`, transactionData);
            alert("Cập nhật transaction thành công!");
            transactionModal.hide();
            window.loadTransactions();
        } catch (err) {
            console.error("Error saving transaction:", err);
            alert("Lỗi: " + (err.message || "Không thể lưu transaction"));
        }
    }

    async function deleteTransaction(id) {
        if (!confirm("Bạn có chắc chắn muốn xóa transaction này không?")) return;

        try {
            await window.apiDelete(`api/transaction/${id}`);
            alert("Xóa transaction thành công!");
            window.loadTransactions();
        } catch (err) {
            console.error("Error deleting transaction:", err);
            alert("Lỗi: " + (err.message || "Không thể xóa transaction"));
        }
    }
</script>

<!-- Security + Logout -->
<script src="../src/js/logout.js"></script>
<script src="../src/js/protect-page.js"></script>


</body>

</html>
