<!DOCTYPE html>

<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Categories Management</title>
    <!-- Bootstrap 5 + Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Custom CSS -->
    <link href="../src/css/style.css" rel="stylesheet">
    <link href="../src/css/sidebar.css" rel="stylesheet">


</head>

<body>


    <!-- Sidebar & Topbar container -->
    <div id="sidebar-container"></div>
    <div id="topbar-container"></div>
    <script type="module">
        import { loadAdminLayout } from "../src/js/admin-layout.js";
        loadAdminLayout();
    </script>

    <!-- Main content -->
    <main class="content">
        <div class="container mt-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2>Quản lý Categories</h2>
                <button class="btn btn-primary" onclick="openAddModal()">
                    <i class="bi bi-plus-circle"></i> Thêm Category
                </button>
            </div>
            <table class="table table-striped mt-3">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Description</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="categoryTableBody"></tbody>
            </table>
        </div>
    </main>

    <!-- Edit/Add Category Modal -->
    <div class="modal fade" id="categoryModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="categoryModalTitle">Chỉnh sửa Category</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="categoryForm">
                        <input type="hidden" id="categoryId">
                        <div class="mb-3">
                            <label class="form-label">Name</label>
                            <input type="text" class="form-control" id="categoryName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" id="categoryDescription" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-primary" onclick="saveCategory()">Lưu</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Load Admin Layout (sidebar + topbar) -->
    <script src="../src/js/admin-layout.js"></script>

    <!-- Load categories từ API -->
    <script type="module">
        import { apiGet, apiPut, apiDelete, apiPost } from "../src/js/api.js";

        window.apiGet = apiGet;
        window.apiPut = apiPut;
        window.apiDelete = apiDelete;
        window.apiPost = apiPost;

        async function loadCategories() {
            try {
                const data = await apiGet("api/category");
                const tbody = document.getElementById("categoryTableBody");
                tbody.innerHTML = "";

                if (!data || data.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="5" class="text-center">Không có dữ liệu</td></tr>`;
                    return;
                }

                data.forEach((c, i) => {
                    tbody.innerHTML += `
            <tr>
                <td>${i + 1}</td>
                <td>${c.id}</td>
                <td>${c.name || ""}</td>
                <td>${c.description || ""}</td>
                <td>
                    <button class="btn btn-sm btn-primary" onclick="openEditModal(${c.id}, '${(c.name || "").replace(/'/g, "\\'")}', '${(c.description || "").replace(/'/g, "\\'")}')">
                        <i class="bi bi-pencil"></i> Edit
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="deleteCategory(${c.id})">
                        <i class="bi bi-trash"></i> Delete
                    </button>
                </td>
            </tr>
        `;
                });
            } catch (err) {
                console.error("Error loading categories:", err);
                document.getElementById("categoryTableBody").innerHTML = 
                    `<tr><td colspan="5" class="text-center text-danger">Lỗi khi tải dữ liệu: ${err.message}</td></tr>`;
            }
        }

        window.loadCategories = loadCategories;
        loadCategories();
    </script>

    <script>
        let categoryModal;

        document.addEventListener("DOMContentLoaded", () => {
            categoryModal = new bootstrap.Modal(document.getElementById("categoryModal"));
        });

        function openAddModal() {
            document.getElementById("categoryModalTitle").textContent = "Thêm Category mới";
            document.getElementById("categoryForm").reset();
            document.getElementById("categoryId").value = "";
            categoryModal.show();
        }

        function openEditModal(id, name, description) {
            document.getElementById("categoryModalTitle").textContent = "Chỉnh sửa Category";
            document.getElementById("categoryId").value = id;
            document.getElementById("categoryName").value = name;
            document.getElementById("categoryDescription").value = description || "";
            categoryModal.show();
        }

        async function saveCategory() {
            const id = document.getElementById("categoryId").value;
            const name = document.getElementById("categoryName").value;
            const description = document.getElementById("categoryDescription").value;

            if (!name) {
                alert("Vui lòng điền tên category!");
                return;
            }

            try {
                const categoryData = {
                    id: id ? parseInt(id) : 0,
                    name: name,
                    description: description || null
                };

                if (id) {
                    await window.apiPut(`api/category/${id}`, categoryData);
                    alert("Cập nhật category thành công!");
                } else {
                    await window.apiPost("api/category", categoryData);
                    alert("Thêm category thành công!");
                }

                categoryModal.hide();
                window.loadCategories();
            } catch (err) {
                console.error("Error saving category:", err);
                alert("Lỗi: " + (err.message || "Không thể lưu category"));
            }
        }

        async function deleteCategory(id) {
            if (!confirm("Bạn có chắc chắn muốn xóa category này không?")) return;

            try {
                await window.apiDelete(`api/category/${id}`);
                alert("Xóa category thành công!");
                window.loadCategories();
            } catch (err) {
                console.error("Error deleting category:", err);
                alert("Lỗi: " + (err.message || "Không thể xóa category"));
            }
        }
    </script>

    <!-- Security + Logout -->
    <script src="../src/js/logout.js"></script>
    <script src="../src/js/protect-page.js"></script>
</body>

</html>