<!DOCTYPE html>

<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Packages Management</title>


<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>


<link href="../src/css/style.css" rel="stylesheet">
<link href="../src/css/sidebar.css" rel="stylesheet">

</head>

<body>

<div id="sidebar-container"></div>
<div id="topbar-container"></div>

<!-- Main Content -->
<main class="content">
    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2>Quản lý Packages</h2>
            <button class="btn btn-primary" onclick="openAddModal()">
                <i class="bi bi-plus-circle"></i> Thêm Package
            </button>
        </div>
        <table class="table table-striped mt-3">
            <thead>
                <tr>
                    <th>#</th>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Description</th>
                    <th>Duration (months)</th>
                    <th>Price</th>
                    <th>Active</th>
                    <th>CreatedAt</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="packageTableBody"></tbody>
        </table>
    </div>
</main>

<!-- Edit/Add Package Modal -->
<div class="modal fade" id="packageModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="packageModalTitle">Chỉnh sửa Package</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="packageForm">
                    <input type="hidden" id="packageId">
                    <div class="mb-3">
                        <label class="form-label">Name</label>
                        <input type="text" class="form-control" id="packageName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" id="packageDescription" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Duration (months)</label>
                        <input type="number" class="form-control" id="packageDurationMonths" min="1" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Price</label>
                        <input type="number" step="0.01" class="form-control" id="packagePrice" min="0" required>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="packageIsActive">
                            <label class="form-check-label" for="packageIsActive">
                                Active
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" onclick="savePackage()">Lưu</button>
            </div>
        </div>
    </div>
</div>

<!-- Load layout (sidebar + topbar) -->
<script type="module">
    import { loadAdminLayout } from "../src/js/admin-layout.js";
    loadAdminLayout();
</script>

<!-- Packages JS -->
<script type="module">
    import { apiGet, apiPut, apiDelete, apiPost } from "../src/js/api.js";

    window.apiGet = apiGet;
    window.apiPut = apiPut;
    window.apiDelete = apiDelete;
    window.apiPost = apiPost;

    async function loadPackages() {
        try {
            const data = await apiGet("api/package");
            const tbody = document.getElementById("packageTableBody");
            tbody.innerHTML = "";

            if (!data || data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="9" class="text-center">Không có dữ liệu</td></tr>`;
                return;
            }

            data.forEach((p, i) => {
                tbody.innerHTML += `<tr>
                    <td>${i + 1}</td>
                    <td>${p.id}</td>
                    <td>${p.name || ""}</td>
                    <td>${p.description || ""}</td>
                    <td>${p.durationMonths || 0}</td>
                    <td>${p.price ? p.price.toFixed(2) : "0.00"}</td>
                    <td><span class="badge bg-${p.isActive ? "success" : "secondary"}">${p.isActive ? "Yes" : "No"}</span></td>
                    <td>${p.createdAt ? new Date(p.createdAt).toLocaleString("vi-VN") : ""}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="openEditModal(${p.id}, '${(p.name || "").replace(/'/g, "\\'")}', '${(p.description || "").replace(/'/g, "\\'")}', ${p.durationMonths || 0}, ${p.price || 0}, ${p.isActive})">
                            <i class="bi bi-pencil"></i> Edit
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deletePackage(${p.id})">
                            <i class="bi bi-trash"></i> Delete
                        </button>
                    </td>
                </tr>`;
            });
        } catch (err) {
            console.error("Error loading packages:", err);
            document.getElementById("packageTableBody").innerHTML = 
                `<tr><td colspan="9" class="text-center text-danger">Lỗi khi tải dữ liệu: ${err.message}</td></tr>`;
        }
    }

    window.loadPackages = loadPackages;
    loadPackages();
</script>

<script>
    let packageModal;

    document.addEventListener("DOMContentLoaded", () => {
        packageModal = new bootstrap.Modal(document.getElementById("packageModal"));
    });

    function openAddModal() {
        document.getElementById("packageModalTitle").textContent = "Thêm Package mới";
        document.getElementById("packageForm").reset();
        document.getElementById("packageId").value = "";
        document.getElementById("packageIsActive").checked = true;
        packageModal.show();
    }

    function openEditModal(id, name, description, durationMonths, price, isActive) {
        document.getElementById("packageModalTitle").textContent = "Chỉnh sửa Package";
        document.getElementById("packageId").value = id;
        document.getElementById("packageName").value = name || "";
        document.getElementById("packageDescription").value = description || "";
        document.getElementById("packageDurationMonths").value = durationMonths || 0;
        document.getElementById("packagePrice").value = price || 0;
        document.getElementById("packageIsActive").checked = isActive;
        packageModal.show();
    }

    async function savePackage() {
        const id = document.getElementById("packageId").value;
        const name = document.getElementById("packageName").value;
        const description = document.getElementById("packageDescription").value;
        const durationMonths = parseInt(document.getElementById("packageDurationMonths").value);
        const price = parseFloat(document.getElementById("packagePrice").value);
        const isActive = document.getElementById("packageIsActive").checked;

        if (!name || durationMonths < 1 || price < 0) {
            alert("Vui lòng điền đầy đủ thông tin!");
            return;
        }

        try {
            const packageData = {
                id: id ? parseInt(id) : 0,
                name: name,
                description: description || null,
                durationMonths: durationMonths,
                price: price,
                isActive: isActive,
                createdAt: id ? undefined : new Date().toISOString()
            };

            if (id) {
                await window.apiPut(`api/package/${id}`, packageData);
                alert("Cập nhật package thành công!");
            } else {
                await window.apiPost("api/package", packageData);
                alert("Thêm package thành công!");
            }

            packageModal.hide();
            window.loadPackages();
        } catch (err) {
            console.error("Error saving package:", err);
            alert("Lỗi: " + (err.message || "Không thể lưu package"));
        }
    }

    async function deletePackage(id) {
        if (!confirm("Bạn có chắc chắn muốn xóa package này không?")) return;

        try {
            await window.apiDelete(`api/package/${id}`);
            alert("Xóa package thành công!");
            window.loadPackages();
        } catch (err) {
            console.error("Error deleting package:", err);
            alert("Lỗi: " + (err.message || "Không thể xóa package"));
        }
    }
</script>



<script src="../src/js/logout.js"></script>
<script src="../src/js/protect-page.js"></script>

</body>

</html>
