<!DOCTYPE html>

<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Subscriptions Management</title>


<!-- Bootstrap 5 + Icons -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- Custom CSS -->
<link href="../src/css/style.css" rel="stylesheet">
<link href="../src/css/sidebar.css" rel="stylesheet">


</head>

<body>


<!-- Sidebar và Topbar sẽ được load tự động -->
<div id="sidebar-container"></div>
<div id="topbar-container"></div>

<!-- Main Content -->
<main class="content">
    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2>Quản lý Subscriptions</h2>
            <button class="btn btn-primary" onclick="openAddModal()">
                <i class="bi bi-plus-circle"></i> Thêm Subscription
            </button>
        </div>
        <table class="table table-striped mt-3">
            <thead>
                <tr>
                    <th>#</th>
                    <th>ID</th>
                    <th>User</th>
                    <th>Package</th>
                    <th>StartDate</th>
                    <th>EndDate</th>
                    <th>PaymentStatus</th>
                    <th>Active</th>
                    <th>CreatedAt</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="subscriptionTableBody"></tbody>
        </table>
    </div>
</main>

<!-- Edit/Add Subscription Modal -->
<div class="modal fade" id="subscriptionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="subscriptionModalTitle">Chỉnh sửa Subscription</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="subscriptionForm">
                    <input type="hidden" id="subscriptionId">
                    <div class="mb-3">
                        <label class="form-label">User ID</label>
                        <input type="number" class="form-control" id="subscriptionUserId">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Package ID</label>
                        <input type="number" class="form-control" id="subscriptionPackageId" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Start Date</label>
                        <input type="date" class="form-control" id="subscriptionStartDate" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">End Date</label>
                        <input type="date" class="form-control" id="subscriptionEndDate" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Payment Status</label>
                        <select class="form-select" id="subscriptionPaymentStatus" required>
                            <option value="Pending">Pending</option>
                            <option value="Completed">Completed</option>
                            <option value="Failed">Failed</option>
                            <option value="Refunded">Refunded</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="subscriptionIsActive">
                            <label class="form-check-label" for="subscriptionIsActive">
                                Active
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" onclick="saveSubscription()">Lưu</button>
            </div>
        </div>
    </div>
</div>

<!-- Load layout (sidebar + topbar) -->
<script type="module">
    import { loadAdminLayout } from "../src/js/admin-layout.js";
    loadAdminLayout();
</script>

<!-- Subscriptions JS -->
<script type="module">
    import { apiGet, apiPut, apiDelete, apiPost } from "../src/js/api.js";

    window.apiGet = apiGet;
    window.apiPut = apiPut;
    window.apiDelete = apiDelete;
    window.apiPost = apiPost;

    let currentSubscription = null;

    async function loadSubscriptions() {
        try {
            const data = await apiGet("api/subscription/with-relations");
            const tbody = document.getElementById("subscriptionTableBody");
            tbody.innerHTML = "";

            if (!data || data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="10" class="text-center">Không có dữ liệu</td></tr>`;
                return;
            }

            data.forEach((s, i) => {
                const userName = s.user?.fullName || s.userName || "N/A";
                const packageName = s.package?.name || s.packageName || "N/A";
                const startDate = s.startDate ? new Date(s.startDate).toLocaleDateString("vi-VN") : "";
                const endDate = s.endDate ? new Date(s.endDate).toLocaleDateString("vi-VN") : "";
                
                tbody.innerHTML += `<tr>
                    <td>${i + 1}</td>
                    <td>${s.id}</td>
                    <td>${userName}</td>
                    <td>${packageName}</td>
                    <td>${startDate}</td>
                    <td>${endDate}</td>
                    <td><span class="badge bg-${getPaymentStatusColor(s.paymentStatus)}">${s.paymentStatus || "Pending"}</span></td>
                    <td><span class="badge bg-${s.isActive ? "success" : "secondary"}">${s.isActive ? "Yes" : "No"}</span></td>
                    <td>${s.createdAt ? new Date(s.createdAt).toLocaleString("vi-VN") : ""}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="openEditModal(${s.id})">
                            <i class="bi bi-pencil"></i> Edit
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteSubscription(${s.id})">
                            <i class="bi bi-trash"></i> Delete
                        </button>
                    </td>
                </tr>`;
            });
        } catch (err) {
            console.error("Error loading subscriptions:", err);
            document.getElementById("subscriptionTableBody").innerHTML = 
                `<tr><td colspan="10" class="text-center text-danger">Lỗi khi tải dữ liệu: ${err.message}</td></tr>`;
        }
    }

    function getPaymentStatusColor(status) {
        switch(status) {
            case "Completed": return "success";
            case "Pending": return "warning";
            case "Failed": return "danger";
            case "Refunded": return "info";
            default: return "secondary";
        }
    }

    window.loadSubscriptions = loadSubscriptions;
    loadSubscriptions();
</script>

<script>
    let subscriptionModal;

    document.addEventListener("DOMContentLoaded", () => {
        subscriptionModal = new bootstrap.Modal(document.getElementById("subscriptionModal"));
    });

    function openAddModal() {
        document.getElementById("subscriptionModalTitle").textContent = "Thêm Subscription mới";
        document.getElementById("subscriptionForm").reset();
        document.getElementById("subscriptionId").value = "";
        document.getElementById("subscriptionIsActive").checked = true;
        document.getElementById("subscriptionPaymentStatus").value = "Pending";
        subscriptionModal.show();
    }

    async function openEditModal(id) {
        try {
            const subscription = await window.apiGet(`api/subscription/${id}`);
            currentSubscription = subscription;
            
            document.getElementById("subscriptionModalTitle").textContent = "Chỉnh sửa Subscription";
            document.getElementById("subscriptionId").value = subscription.id;
            document.getElementById("subscriptionUserId").value = subscription.userId || "";
            document.getElementById("subscriptionPackageId").value = subscription.packageId || "";
            
            if (subscription.startDate) {
                const startDate = new Date(subscription.startDate);
                document.getElementById("subscriptionStartDate").value = startDate.toISOString().split('T')[0];
            }
            
            if (subscription.endDate) {
                const endDate = new Date(subscription.endDate);
                document.getElementById("subscriptionEndDate").value = endDate.toISOString().split('T')[0];
            }
            
            document.getElementById("subscriptionPaymentStatus").value = subscription.paymentStatus || "Pending";
            document.getElementById("subscriptionIsActive").checked = subscription.isActive;
            
            subscriptionModal.show();
        } catch (err) {
            console.error("Error loading subscription:", err);
            alert("Lỗi khi tải thông tin subscription: " + err.message);
        }
    }

    async function saveSubscription() {
        const id = document.getElementById("subscriptionId").value;
        const userId = document.getElementById("subscriptionUserId").value ? parseInt(document.getElementById("subscriptionUserId").value) : null;
        const packageId = parseInt(document.getElementById("subscriptionPackageId").value);
        const startDate = document.getElementById("subscriptionStartDate").value;
        const endDate = document.getElementById("subscriptionEndDate").value;
        const paymentStatus = document.getElementById("subscriptionPaymentStatus").value;
        const isActive = document.getElementById("subscriptionIsActive").checked;

        if (!packageId || !startDate || !endDate) {
            alert("Vui lòng điền đầy đủ thông tin!");
            return;
        }

        try {
            const subscriptionData = {
                id: id ? parseInt(id) : 0,
                userId: userId,
                packageId: packageId,
                startDate: startDate,
                endDate: endDate,
                paymentStatus: paymentStatus,
                isActive: isActive,
                createdAt: id ? currentSubscription?.createdAt : new Date().toISOString()
            };

            if (id) {
                await window.apiPut(`api/subscription/${id}`, subscriptionData);
                alert("Cập nhật subscription thành công!");
            } else {
                await window.apiPost("api/subscription/create", subscriptionData);
                alert("Thêm subscription thành công!");
            }

            subscriptionModal.hide();
            window.loadSubscriptions();
        } catch (err) {
            console.error("Error saving subscription:", err);
            alert("Lỗi: " + (err.message || "Không thể lưu subscription"));
        }
    }

    async function deleteSubscription(id) {
        if (!confirm("Bạn có chắc chắn muốn xóa subscription này không?")) return;

        try {
            await window.apiDelete(`api/subscription/${id}`);
            alert("Xóa subscription thành công!");
            window.loadSubscriptions();
        } catch (err) {
            console.error("Error deleting subscription:", err);
            alert("Lỗi: " + (err.message || "Không thể xóa subscription"));
        }
    }
</script>

<!-- Security + Logout -->
<script src="../src/js/logout.js"></script>
<script src="../src/js/protect-page.js"></script>


</body>

</html>
