<!DOCTYPE html>

<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Templates Management</title>


<!-- Bootstrap 5 + Icons -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- Custom CSS -->
<link href="../src/css/style.css" rel="stylesheet">
<link href="../src/css/sidebar.css" rel="stylesheet">

<style>
    .template-thumbnail {
        transition: transform 0.2s;
    }
    .template-thumbnail:hover {
        transform: scale(1.1);
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    .image-modal img {
        max-width: 100%;
        height: auto;
    }
    .video-modal iframe {
        width: 100%;
        min-height: 400px;
    }
</style>


</head>

<body>


<!-- Sidebar và Topbar sẽ được load tự động -->
<div id="sidebar-container"></div>
<div id="topbar-container"></div>

<!-- Main Content -->
<main class="content">
    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2>Quản lý Templates</h2>
            <button class="btn btn-primary" onclick="openAddModal()">
                <i class="bi bi-plus-circle"></i> Thêm Template
            </button>
        </div>
        <table class="table table-striped mt-3">
            <thead>
                <tr>
                    <th>#</th>
                    <th>ID</th>
                    <th>Category</th>
                    <th>Title</th>
                    <th>Image</th>
                    <th>Video</th>
                    <th>Price</th>
                    <th>Active</th>
                    <th>CreatedAt</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="templateTableBody"></tbody>
        </table>
    </div>
</main>

<!-- Edit/Add Template Modal -->
<div class="modal fade" id="templateModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="templateModalTitle">Chỉnh sửa Template</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="templateForm">
                    <input type="hidden" id="templateId">
                    <div class="mb-3">
                        <label class="form-label">Category</label>
                        <select class="form-select" id="templateCategoryId" required>
                            <option value="">Chọn category...</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Title</label>
                        <input type="text" class="form-control" id="templateTitle" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Image URL</label>
                        <input type="url" class="form-control" id="templateImageUrl">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Video URL</label>
                        <input type="url" class="form-control" id="templateVideoUrl">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Price</label>
                        <input type="number" step="0.01" class="form-control" id="templatePrice" required>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="templateIsActive">
                            <label class="form-check-label" for="templateIsActive">
                                Active
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" onclick="saveTemplate()">Lưu</button>
            </div>
        </div>
    </div>
</div>

<!-- Image Preview Modal -->
<div class="modal fade" id="imageModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Xem Hình Ảnh</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body image-modal text-center">
                <img id="modalImage" src="" alt="Template Image" class="img-fluid">
            </div>
        </div>
    </div>
</div>

<!-- Video Preview Modal -->
<div class="modal fade" id="videoModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Xem Video</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body video-modal">
                <iframe id="modalVideo" src="" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
            </div>
        </div>
    </div>
</div>

<!-- Load layout (sidebar + topbar) -->
<script type="module">
    import { loadAdminLayout } from "../src/js/admin-layout.js";
    loadAdminLayout();
</script>

<!-- Templates JS -->
<script type="module">
    import { apiGet, apiPut, apiDelete, apiPost } from "../src/js/api.js";

    window.apiGet = apiGet;
    window.apiPut = apiPut;
    window.apiDelete = apiDelete;
    window.apiPost = apiPost;

    let categories = [];

    async function loadCategories() {
        try {
            categories = await apiGet("api/category");
            const select = document.getElementById("templateCategoryId");
            select.innerHTML = '<option value="">Chọn category...</option>';
            categories.forEach(cat => {
                select.innerHTML += `<option value="${cat.id}">${cat.name}</option>`;
            });
        } catch (err) {
            console.error("Error loading categories:", err);
        }
    }

    async function loadTemplates() {
        try {
            const data = await apiGet("api/template/with-relations");
            const tbody = document.getElementById("templateTableBody");
            tbody.innerHTML = "";

            if (!data || data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="10" class="text-center">Không có dữ liệu</td></tr>`;
                return;
            }

            data.forEach((t, i) => {
                const imageUrl = t.imageUrl || "";
                const videoUrl = t.videoUrl || "";
                const imageDisplay = imageUrl ? 
                    `<img src="${imageUrl}" alt="Template Image" class="template-thumbnail" onclick="showImageModal('${imageUrl.replace(/'/g, "\\'")}')" style="cursor: pointer; max-width: 80px; max-height: 60px; object-fit: cover; border-radius: 4px;">` : 
                    '<span class="text-muted">N/A</span>';
                const videoDisplay = videoUrl ? 
                    `<button class="btn btn-sm btn-info" onclick="showVideoModal('${videoUrl.replace(/'/g, "\\'")}')">
                        <i class="bi bi-play-circle"></i> Xem Video
                    </button>` : 
                    '<span class="text-muted">N/A</span>';
                
                tbody.innerHTML += `
                <tr>
                    <td>${i + 1}</td>
                    <td>${t.id}</td>
                    <td>${t.categoryName || "N/A"}</td>
                    <td>${t.title || ""}</td>
                    <td>${imageDisplay}</td>
                    <td>${videoDisplay}</td>
                    <td>${t.price ? t.price.toFixed(2) : "0.00"}</td>
                    <td><span class="badge bg-${t.isActive ? "success" : "secondary"}">${t.isActive ? "Yes" : "No"}</span></td>
                    <td>${t.createdAt ? new Date(t.createdAt).toLocaleString("vi-VN") : ""}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="openEditModal(${t.id}, ${t.categoryId || 0}, '${(t.title || "").replace(/'/g, "\\'")}', '${imageUrl.replace(/'/g, "\\'")}', '${videoUrl.replace(/'/g, "\\'")}', ${t.price || 0}, ${t.isActive})">
                            <i class="bi bi-pencil"></i> Edit
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteTemplate(${t.id})">
                            <i class="bi bi-trash"></i> Delete
                        </button>
                    </td>
                </tr>
            `;
            });
        } catch (err) {
            console.error("Error loading templates:", err);
            document.getElementById("templateTableBody").innerHTML = 
                `<tr><td colspan="10" class="text-center text-danger">Lỗi khi tải dữ liệu: ${err.message}</td></tr>`;
        }
    }

    window.loadTemplates = loadTemplates;
    window.loadCategories = loadCategories;
    
    loadCategories();
    loadTemplates();
</script>

<script>
    let templateModal;

    document.addEventListener("DOMContentLoaded", () => {
        templateModal = new bootstrap.Modal(document.getElementById("templateModal"));
    });

    function openAddModal() {
        document.getElementById("templateModalTitle").textContent = "Thêm Template mới";
        document.getElementById("templateForm").reset();
        document.getElementById("templateId").value = "";
        document.getElementById("templateIsActive").checked = true;
        templateModal.show();
    }

    function openEditModal(id, categoryId, title, imageUrl, videoUrl, price, isActive) {
        document.getElementById("templateModalTitle").textContent = "Chỉnh sửa Template";
        document.getElementById("templateId").value = id;
        document.getElementById("templateCategoryId").value = categoryId || "";
        document.getElementById("templateTitle").value = title || "";
        document.getElementById("templateImageUrl").value = imageUrl || "";
        document.getElementById("templateVideoUrl").value = videoUrl || "";
        document.getElementById("templatePrice").value = price || 0;
        document.getElementById("templateIsActive").checked = isActive;
        templateModal.show();
    }

    async function saveTemplate() {
        const id = document.getElementById("templateId").value;
        const categoryId = document.getElementById("templateCategoryId").value;
        const title = document.getElementById("templateTitle").value;
        const imageUrl = document.getElementById("templateImageUrl").value;
        const videoUrl = document.getElementById("templateVideoUrl").value;
        const price = parseFloat(document.getElementById("templatePrice").value);
        const isActive = document.getElementById("templateIsActive").checked;

        if (!categoryId || !title || price < 0) {
            alert("Vui lòng điền đầy đủ thông tin!");
            return;
        }

        try {
            const templateData = {
                categoryId: parseInt(categoryId),
                title: title,
                imageUrl: imageUrl || null,
                videoUrl: videoUrl || null,
                price: price,
                isActive: isActive
            };

            if (id) {
                await window.apiPut(`api/template/${id}/update`, templateData);
                alert("Cập nhật template thành công!");
            } else {
                await window.apiPost("api/template/create", templateData);
                alert("Thêm template thành công!");
            }

            templateModal.hide();
            window.loadTemplates();
        } catch (err) {
            console.error("Error saving template:", err);
            alert("Lỗi: " + (err.message || "Không thể lưu template"));
        }
    }

    async function deleteTemplate(id) {
        if (!confirm("Bạn có chắc chắn muốn xóa template này không?")) return;

        try {
            await window.apiDelete(`api/template/delete/${id}`);
            alert("Xóa template thành công!");
            window.loadTemplates();
        } catch (err) {
            console.error("Error deleting template:", err);
            alert("Lỗi: " + (err.message || "Không thể xóa template"));
        }
    }

    function showImageModal(imageUrl) {
        const imageModal = new bootstrap.Modal(document.getElementById("imageModal"));
        document.getElementById("modalImage").src = imageUrl;
        imageModal.show();
    }

    function showVideoModal(videoUrl) {
        const videoModal = new bootstrap.Modal(document.getElementById("videoModal"));
        // Convert YouTube URL to embed format if needed
        let embedUrl = videoUrl;
        if (videoUrl.includes("youtube.com/watch")) {
            const videoId = videoUrl.split("v=")[1]?.split("&")[0];
            embedUrl = `https://www.youtube.com/embed/${videoId}`;
        } else if (videoUrl.includes("youtu.be/")) {
            const videoId = videoUrl.split("youtu.be/")[1]?.split("?")[0];
            embedUrl = `https://www.youtube.com/embed/${videoId}`;
        }
        document.getElementById("modalVideo").src = embedUrl;
        videoModal.show();
        
        // Clear video when modal is closed
        document.getElementById("videoModal").addEventListener("hidden.bs.modal", function() {
            document.getElementById("modalVideo").src = "";
        }, { once: true });
    }
</script>

<!-- Security + Logout -->
<script src="../src/js/logout.js"></script>
<script src="../src/js/protect-page.js"></script>
</body>

</html>
